version: '3.8'

services:
  # ============================================================================
  # VESSELS - UNIFIED CONTAINER
  # All-in-one: Python + Node.js + TEN Framework + TigerBeetle + Petals + FalkorDB
  # ============================================================================

  vessels:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vessels-unified
    ports:
      - "5000:5000"    # Vessels web interface
      - "6379:6379"    # FalkorDB
      - "3000:3000"    # Payment service API
      - "8080:8080"    # TEN Framework
    environment:
      # Python/Vessels
      - PYTHONUNBUFFERED=1
      - FALKORDB_HOST=localhost
      - FALKORDB_PORT=6379
      - DAEMON=true

      # Payment Service
      - PAYMENT_SERVICE_URL=http://localhost:3000
      - PORT=3000
      - NODE_ENV=production

      # TigerBeetle Cluster
      - TIGERBEETLE_CLUSTER_ID=${TIGERBEETLE_CLUSTER_ID:-0}
      - TIGERBEETLE_REPLICA_ADDRESSES=tigerbeetle-0:3001,tigerbeetle-1:3001,tigerbeetle-2:3001

      # Database - POSTGRES_PASSWORD must be set in .env file
      - DATABASE_URL=postgresql://vessels:${POSTGRES_PASSWORD}@localhost:5432/vessels_payment
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set in .env file}

      # Auth - JWT_SECRET must be set in .env file
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET must be set in .env file}

      # Mojaloop (optional)
      - MOJALOOP_ENABLED=${MOJALOOP_ENABLED:-false}
      - MOJALOOP_SWITCH_URL=${MOJALOOP_SWITCH_URL:-}
      - MOJALOOP_PARTICIPANT_ID=${MOJALOOP_PARTICIPANT_ID:-vessels-dfsp}
      - MOJALOOP_API_KEY=${MOJALOOP_API_KEY:-}
      - MOJALOOP_CALLBACK_URL=${MOJALOOP_CALLBACK_URL:-}

      # TEN Framework
      - TEN_FRAMEWORK_ENABLED=${TEN_FRAMEWORK_ENABLED:-true}
      - TEN_GRAPHS_DIR=/app/graphs

      # Petals (distributed AI)
      - PETALS_ENABLED=${PETALS_ENABLED:-false}
      - PETALS_MODEL=${PETALS_MODEL:-petals-team/StableBeluga2}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

    volumes:
      - ./work_dir:/app/work_dir
      - vessels-data:/data
      - ./config:/app/config
      - ./graphs:/app/graphs
      - ./ten_packages:/app/ten_packages
    networks:
      - vessels-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -p 6379 ping && curl -f http://localhost:5000/health && curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # TIGERBEETLE CLUSTER - Financial Ledger
  # 3-node cluster for production reliability
  # ============================================================================

  tigerbeetle-0:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: tigerbeetle-0
    command: start --addresses=0.0.0.0:3001,tigerbeetle-1:3001,tigerbeetle-2:3001 /data/0_0.tigerbeetle
    ports:
      - "3001:3001"
    volumes:
      - tigerbeetle-data-0:/data
    networks:
      - vessels-network
    restart: unless-stopped

  tigerbeetle-1:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: tigerbeetle-1
    command: start --addresses=tigerbeetle-0:3001,0.0.0.0:3001,tigerbeetle-2:3001 /data/0_1.tigerbeetle
    volumes:
      - tigerbeetle-data-1:/data
    networks:
      - vessels-network
    restart: unless-stopped
    depends_on:
      - tigerbeetle-0

  tigerbeetle-2:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: tigerbeetle-2
    command: start --addresses=tigerbeetle-0:3001,tigerbeetle-1:3001,0.0.0.0:3001 /data/0_2.tigerbeetle
    volumes:
      - tigerbeetle-data-2:/data
    networks:
      - vessels-network
    restart: unless-stopped
    depends_on:
      - tigerbeetle-1

volumes:
  vessels-data:
    driver: local
  tigerbeetle-data-0:
    driver: local
  tigerbeetle-data-1:
    driver: local
  tigerbeetle-data-2:
    driver: local

networks:
  vessels-network:
    driver: bridge
